<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mappa di Fano</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map {
            height: 400px;
            width: 100%;
        }
        .popup-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background-color: #fff;
            border: 1px solid #ccc;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        </style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<h1>Ottieni PI</h1>
<button onclick="getPI()">Get PI</button>
<h2>PI List</h2>
<ul id="piList"></ul>

<h2>Get PI by Titolo</h2>
<label for="getTitolo">PI Titolo:</label>
<input type="text" id="getTitolo">
<button onclick="getPIByTitle()">Get PI</button>
<div id="piResult"></div>

<h1>Ottieni elementi PI</h1>
<label for="titoloPI">PI Titolo:</label>
<input type="text" id="titoloPI">
<button onclick="getElementiPI()">Get Elementi</button>
<ul id="elementiList"></ul>

<h2>Crea commento</h2>
<form id="commentoForm">
    <label for="commentoId">Commento id:</label>
    <input type="text" id="commentoId" name="commentoId" disabled><br><br>
    <label for="commentoTitolo">CommentoTitolo:</label>
    <input type="text" id="commentoTitolo" name="commentoTitolo" required><br><br>
    <label for="commentoDescrizione">commento Descrizione:</label>
    <input type="text" id="commentoDescrizione" name="commentoDescrizione" required><br><br>
    <label for="piRiferimento">Titolo PI Riferimento:</label>
    <input type="text" id="piRiferimento" name="piRiferimento" required><br><br>
    <button type="button" onclick="creaCommento()">Crea Commento</button>
</form>

<h1>Ottieni Contenuto</h1>
<button onclick="getContenuto()">Get Contenuto</button>
<h2>contenuto List</h2>
<ul id="contenutoList"></ul>

<h1>Ottieni Commenti</h1>
<button onclick="getCommenti()">Get Commenti</button>
<h2>commenti List</h2>
<ul id="commentiList"></ul>

<h2>Get contenuto by titolo</h2>
<label for="titoloContenuto">contenuto Titolo:</label>
<input type="text" id="titoloContenuto">
<button onclick="getContenutoByTitle()">Get contenuto</button>
<div id="contenutoResult"></div>

<h2>Get commento by titolo</h2>
<label for="titoloCommento">commento Titolo:</label>
<input type="text" id="titoloCommento">
<button onclick="getCommentoByTitle()">Get commento</button>
<div id="commentoResult"></div>

<h1>Ottieni Esperienze</h1>
<button onclick="getEsperienze()">Ottieni Esperienza</button>
<h2>esperienza List</h2>
<ul id="esperienzaList"></ul>

<h2>Get esperienza by titolo</h2>
<label for="titolo">esperienza Titolo:</label>
<input type="text" id="titolo">
<button onclick="getEsperienzaByTitle()">Get esperienza</button>
<div id="esperienzaResult"></div>

<h1>Aggiungi Segnalazione</h1>
<form id="aggiungiSegnalazioneForm">
    <label for="idSegnalazione">ID Segnalazione:</label>
    <input type="text" id="idSegnalazione" name="idSegnalazione" disabled><br>
    <label for="idElemento">ID Elemento:</label>
    <input type="text" id="idElemento" name="idElemento"><br>
    <label for="descrizioneSegnalazione">descrizione :</label>
    <input type="text" id="descrizioneSegnalazione" name="descrizioneSegnalazione"><br>
    <button type="button" onclick="inviaSegnalazione()">Aggiungi Segnalazione</button>
</form>
<script>
    if (!sessionStorage.getItem('isAuthenticated')) {
        window.location.href = '/login.html';
    }
    var map = L.map('map').setView([43.8396, 13.0148], 15);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
    }).addTo(map);

    L.marker([43.8396, 13.0148]).addTo(map)
        .bindPopup('Fano, Italia')
        .openPopup();

    const baseUrl = 'http://localhost:8080';

    function getPI() {
        fetch(`${baseUrl}/AllPI`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Errore nella richiesta.');
                }
                return response.json();
            })
            .then(data => {
                const piList = document.getElementById('piList');
                piList.innerHTML = '';

                data.forEach(pi => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `ID: ${pi.idPI}, Descrizione: ${pi.descrizione}, Titolo: ${pi.titolo}, Tipologia: ${pi.tipologia}, Latitudine: ${pi.latitudine}, Longitudine: ${pi.longitudine}`;
                    piList.appendChild(listItem);
                });
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Si è verificato un errore durante il recupero dei PI.');
            });
    }

    function getElementiPI() {
        const titoloPI = document.getElementById('titoloPI').value;

        fetch(`${baseUrl}/PI/elementi/titolo?titolo=${encodeURIComponent(titoloPI)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Errore nella richiesta.');
                }
                return response.json();
            })
            .then(data => {
                const elementiList = document.getElementById('elementiList');
                elementiList.innerHTML = '';
                data.forEach(elemento => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `ID: ${elemento.idElemento}, Descrizione: ${elemento.descrizione}, Titolo: ${elemento.titolo}, Tipologia: ${elemento.tipologia}`;
                    elementiList.appendChild(listItem);
                });
            })
            .catch(error => console.error('Errore:', error));
    }

    function getPIByTitle() {
        const getTitolo = document.getElementById('getTitolo').value;

        fetch(`${baseUrl}/PI/titolo?titolo=${encodeURIComponent(getTitolo)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Errore nella richiesta.');
                }
                return response.json();
            })
            .then(pi => {
                const piResult = document.getElementById('piResult');
                if (pi!=null) {
                    piResult.textContent = `ID: ${pi.idPI}, Descrizione: ${pi.descrizione}, Titolo: ${pi.titolo}, Tipologia: ${pi.tipologia}, Latitudine: ${pi.latitudine}, Longitudine: ${pi.longitudine}`;
                } else {
                    piResult.textContent = `PI non trovato.`;
                }
            })
            .catch(error => console.error('Errore:', error));
    }
    function getContenuto() {
        fetch(`${baseUrl}/contenuti`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Errore nella richiesta.');
                }
                return response.json();
            })
            .then(data => {
                const contenutoList = document.getElementById('contenutoList');
                contenutoList.innerHTML = '';
                data.forEach(contenuto => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `ID: ${contenuto.idElemento}, Descrizione: ${contenuto.descrizione}, Titolo: ${contenuto.titolo}, PI Riferimento: ${contenuto.piRiferimento}`;
                    contenutoList.appendChild(listItem);
                });
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Si è verificato un errore durante il recupero del contenuto.');
            });
    }

    function getCommenti() {
        fetch(`${baseUrl}/commenti`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Errore nella richiesta.');
                }
                return response.json();
            })
            .then(data => {
                const commentiList = document.getElementById('commentiList');
                commentiList.innerHTML = '';

                data.forEach(commento => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `ID: ${commento.idElemento}, Descrizione: ${commento.descrizione}, Titolo: ${commento.titolo}, Tipologia: ${commento.tipologia}, PiRiferimento: ${commento.piRiferimento}`;
                    commentiList.appendChild(listItem);
                });
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Si è verificato un errore durante il recupero del commento.');
            });
    }

    function getContenutoByTitle() {
        const titoloContenuto = document.getElementById('titoloContenuto').value;

        fetch(`${baseUrl}/contenuto/titolo?titolo=${encodeURIComponent(titoloContenuto)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Errore nella richiesta.');
                }
                return response.json();
            })
            .then(contenuto => {
                const contenutoResult = document.getElementById('contenutoResult');
                if (contenuto != null) {
                    contenutoResult.innerHTML = `ID: ${contenuto.idElemento}, Descrizione: ${contenuto.descrizione}, Titolo: ${contenuto.titolo}, PI Riferimento: ${contenuto.piRiferimento}`;

                    if (contenuto.immagine) {
                        const byteCharacters = atob(contenuto.immagine);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);

                        const blob = new Blob([byteArray], { type: 'image/jpeg' });

                        const url = URL.createObjectURL(blob);

                        var modal = document.createElement('div');
                        modal.classList.add('modal');
                        var img = document.createElement('img');
                        img.src = url;
                        modal.appendChild(img);
                        document.body.appendChild(modal);
                        modal.addEventListener('click', function() {
                            modal.remove();
                        });
                    }
                } else {
                    contenutoResult.textContent = `Contenuto non trovato.`;
                }
            })
            .catch(error => console.error('Errore:', error));
    }
    function getCommentoByTitle() {
        const titoloCommento = document.getElementById('titoloCommento').value;

        fetch(`${baseUrl}/commento/titolo?titolo=${encodeURIComponent(titoloCommento)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Errore nella richiesta.');
                }
                return response.json();
            })
            .then(commento => {
                const commentoResult = document.getElementById('commentoResult');
                if (commento!=null) {
                    commentoResult.textContent = `ID: ${commento.idElemento}, Descrizione: ${commento.descrizione}, Titolo: ${commento.titolo}, Tipologia: ${commento.tipologia},PiRiferimento: ${commento.piRiferimento}`;
                } else {
                    commentoResult.textContent = `Commento non trovato.`;
                }
            })
            .catch(error => console.error('Errore:', error));
    }

    function creaCommento() {
        const commentoId=document.getElementById('commentoId').value;
        const commentoTitolo = document.getElementById('commentoTitolo').value;
        const commentoDescrizione = document.getElementById('commentoDescrizione').value;
        const piRiferimento = document.getElementById('piRiferimento').value;

        const commento = {
            idElemento: commentoId,
            titolo: commentoTitolo,
            descrizione: commentoDescrizione,
            piRiferimento: piRiferimento,
        };

        fetch(`${baseUrl}/creaCommento`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(commento),
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Errore nella richiesta.');
                }
                return response.json();
            })
            .then(data => {
                console.log('Dati ricevuti:', data);
                alert('commento in attesa di autorizzazione!');
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Si è verificato un errore durante l\'aggiunta del commento.');
            });
    }

    function getEsperienze(){
        fetch(`${baseUrl}/esperienze`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Errore nella richiesta.');
                }
                return response.json();
            })
            .then(data => {
                const esperienzaList = document.getElementById('esperienzaList');
                esperienzaList.innerHTML = '';
                data.forEach(esperienza => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `ID: ${esperienza.idElemento}, Descrizione: ${esperienza.descrizione}, Titolo: ${esperienza.titolo}, Tipologia: ${esperienza.tipologia}, ListaPI: ${esperienza.listaPI}, PiRiferimento: ${esperienza.piRiferimento}`;
                    esperienzaList.appendChild(listItem);
                });
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Si è verificato un errore durante il recupero delle Esperienze.');
            });
    }

    function getEsperienzaByTitle() {
        const titolo = document.getElementById('titolo').value;

        fetch(`${baseUrl}/esperienza/titolo?titolo=${encodeURIComponent(titolo)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Errore nella richiesta.');
                }
                return response.json();
            })
            .then(esperienza => {
                const esperienzaResult = document.getElementById('esperienzaResult');
                if (esperienza != null) {
                    esperienzaResult.textContent = `ID: ${esperienza.idElemento}, Descrizione: ${esperienza.descrizione}, Titolo: ${esperienza.titolo}, Tipologia: ${esperienza.tipologia}, ListaPI: ${esperienza.listaPI}, PiRiferimento: ${esperienza.piRiferimento}`;
                } else {
                    esperienzaResult.textContent = `Esperienza non trovata.`;
                }
            })
            .catch(error => console.error('Errore:', error));
    }

    function inviaSegnalazione() {
        var idSegnalazione = document.getElementById('idSegnalazione').value;
        var idElemento = document.getElementById('idElemento').value;
        var descrizioneSegnalazione = document.getElementById('descrizioneSegnalazione').value;

        var segnalazioneData = {
            idSegnalazione: idSegnalazione,
            idElemento:idElemento,
            descrizione: descrizioneSegnalazione
        };

        fetch(`${baseUrl}/pubblicaSegnalazione`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(segnalazioneData)
        })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('Errore durante l\'aggiunta della segnalazione');
                }
            })
            .then(data => {
                console.log('Segnalazione aggiunta con successo:', data);
                alert('Segnalazione generata con successo');
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Errore');
            });
    }
</script>
</body>
</html>